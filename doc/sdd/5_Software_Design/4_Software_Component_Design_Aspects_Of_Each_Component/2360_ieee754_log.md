### \_\_ieee754\_log {#sec:component-ieee-log}

\begin{sffamily}\small
	\begin{center}
		\begin{tabularx}{\dimexpr\textwidth-1\tabcolsep}{p{2.3cm}X}
			Interface       & \texttt{double \_\_ieee754\_log(double x)} \\ 
			
			Type & Internal Procedure    \\ 
			
			Files & \texttt{libm/math/e\_log.c}    \\ 
			
			Subordinates and Superiors &
			\raisebox{-1\height}{\includegraphics[]{./figure/Declaration-__ieee754_log.png}}    \\ 
			
			Purpose & 
			The internal \texttt{\_\_ieee754\_log} function shall return $\log{x}$. \newline
			This component does not implement software requirements by itself.    \\ 
			
			References & \texttt{\_\_ieee754\_logf} \ref{sec:component-ieee-logf}, \texttt{log} \ref{sec:component-log}    \\ 
		\end{tabularx}
	\end{center}
\end{sffamily}

#### Procedure Design

\begin{compactenum}
	\item If x is \texttt{NaN} or positive infinity, return x+x.
	\item If x is a zero, return negative infinity.
	\item If x is negative, return \texttt{NaN}.
	\item If x is subnormal, scale up by multiplying with $2^{54}$.
	\item Given x find f and integer k such that the formulae \footnote{This implementation of log is a variation of the algorithm proposed by W. J. Cody, JR. and W. Waite in "Software Manual for the Elementary Functions"}
	\begin{gather}
		x = 2^k \cdot (1 + f)  \label{formula_log_1} \\
		\frac{\sqrt{2}}{2} < (1 + f) < \sqrt{2} \label{formula_log_2}
	\end{gather}
	hold true.\footnote{Use \texttt{mantissa part of highword} + \texttt{0x95f64} to find k.} Decrease k by 54 if x was subnormal in the previous step.
	\item Approximate $\log{(1+f)}$:
	\begin{compactenum}
		\item Let $s$ be $\frac{f}{2+f}$, based on:
		\begin{align}
			\log{(1+f)} &= \log{(1+s)} - \log{(1-s)} \nonumber \\
					  &= 2s + s \cdot \sum\limits_{i=1}^{\infty} \bigg(\frac{2}{2i+1} \cdot s^2\bigg) \nonumber \\
					  &= 2s + s \cdot R(z) \wedge z = 2s \label{formula_log_3}
		\end{align}
		\item Use the following polynomial to approximate $R(z)$:
		\begin{align}
			R(z) \sim L1 \cdot s^2 + L2 \cdot s^4 + L3 \cdot s^6 + L4 \cdot s^8 + L5 \cdot s^{10} +L6 \cdot s^{12} + L7 \cdot s^{14}  \label{formula_log_4}
		\end{align}
		with
		\begin{compactitem}
			\item $L1$ = \texttt{0x3FE5555555555593} (6.666666666666735130 $\cdot 10^{-1}$)
			\item $L2$ = \texttt{0x3FD999999997FA04} (3.999999999940941908 $\cdot 10^{-1}$)
			\item $L3$ = \texttt{0x3FD2492494229359} (2.857142874366239149 $\cdot 10^{-1}$)
			\item $L4$ = \texttt{0x3FCC71C51D8E78AF} (2.222219843214978396 $\cdot 10^{-1}$)
			\item $L5$ = \texttt{0x3FC7466496CB03DE} (1.818357216161805012 $\cdot 10^{-1}$)
			\item $L6$ = \texttt{0x3FC39A09D078C69F} (1.531383769920937332 $\cdot 10^{-1}$)
			\item $L7$ = \texttt{0x3FC2F112DF3E5244} (1.479819860511658591 $\cdot 10^{-1}$)
		\end{compactitem}
		The error of this approximation is smaller than or equal to $2^{-58.45}$.
		\item To ensure that the error of $\log{(1+f)}$ is below 1 \gls{ULP} use the identity:
		\begin{align}
			2s = f - s \cdot f = f - \frac{f^2}{2} + s \cdot \frac{f^2}{2} \label{formula_log_5}
		\end{align}
		Therefore if f is not too large\footnote{f is too large when 0x6147A < mantissa part of highword of x < 0x6B851.}:
		\begin{align}
			\log{(1+f)} = f - s \cdot (f - R) \label{formula_log_6}
		\end{align}
		Otherwise:
		\begin{align}
			\log{(1+f)} = f - \bigg(\frac{f^2}{2} - s \cdot \Big(\frac{f^2}{2} - R\Big)\bigg) \label{formula_log_7}
		\end{align}
	\end{compactenum}
	\item If k is 0, return $\log{(1+f)}$.
	\item Return (split $Ln2$ into $Ln2_{hi}$ and $Ln2_{lo}$ for more accuracy)
	\begin{align}
		\log{(x)}   &= k \cdot Ln2 + \log{(1+f)} \nonumber \\
				    &= k \cdot Ln2_{hi} + (f - (s \cdot (f - R) + k \cdot Ln2_{lo}))  \label{formula_log_8} \\
		\vee \qquad &= k \cdot Ln2_{hi} + \Bigg(f - \bigg(\frac{f^2}{2} - s \cdot \Big(\frac{f^2}{2} - R\Big) + k \cdot Ln2_{lo}\bigg)\Bigg)  \label{formula_log_9}
	\end{align}
	with
	\begin{compactitem}
		\item $Ln2_{hi}$ = \texttt{0x3FE62E42FEE00000} (6.93147180369123816490 $\cdot 10^{-1}$)
		\item $Ln2_{lo}$ = \texttt{0x3DEA39EF35793C76} (1.90821492927058770002 $\cdot 10^{-10}$)
	\end{compactitem}
	Use formula \ref{formula_log_8} if formula \ref{formula_log_6} was used earlier, otherwise use \ref{formula_log_9}.
\end{compactenum}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.78\textwidth]{./figure/Ieee_Log_Flowchart.pdf}
	\caption{Flowchart \_\_ieee754\_log}
	\label{fig:flowchart-ieee_log}
\end{figure}