### \_\_ieee754\_pow {#sec:component-ieee-pow}

\begin{sffamily}\small
	\begin{center}
		\begin{tabularx}{\dimexpr\textwidth-1\tabcolsep}{p{2.3cm}X}
			Interface       & \texttt{double \_\_ieee754\_pow(double x, double y)} \\ 
			
			Type & Internal procedure    \\ 
			
			Files & \texttt{libm/math/e\_pow.c}    \\ 
			
			Subordinates and Superiors &
			\raisebox{-1\height}{\includegraphics[]{./figure/Declaration-__ieee754_pow.png}}    \\ 
			
			Purpose & The internal \texttt{\_\_ieee754\_pow} function shall return $x^y$. \newline
			This component does not implement software requirements by itself.    \\ 
						
			References & \texttt{\_\_ieee754\_powf} \ref{sec:component-ieee-powf}, \texttt{pow} \ref{sec:component-pow}, \texttt{\_\_ieee754\_sqrt} \ref{sec:component-ieee-sqrt}, \texttt{nan} \ref{sec:component-nan}, \texttt{fabs} \ref{sec:component-fabs}, \texttt{scalbn} \ref{sec:component-scalbn}, \texttt{\_\_ieee754\_log} \ref{sec:component-ieee-log}, \texttt{\_\_ieee754\_exp} \ref{sec:component-ieee-exp}    \\ 
		\end{tabularx}
	\end{center}
\end{sffamily}

#### Procedure Design

\begin{compactenum}
	\item Use the following constants throughout the implementation of the internal pow function:
	\begin{compactitem}
		\item $lg2$      = \texttt{0x3FE62E42FEFA39EF} (6.93147180559945286227 $\cdot 10^{-1}$, equals $ln(2)$)
		\item $lg2_h$    = \texttt{0x3FE62E4300000000} (6.93147182464599609375 $\cdot 10^{-1}$)
		\item $lg2_l$    = \texttt{0xBE205C610CA86C39} (-1.90465429995776804525 $\cdot 10^{-9}$)
		\item $invln2$   = \texttt{0x3FF71547652B82FE} (1.44269504088896338700 $\cdot 10^{-1}$, equals $\frac{1}{ln(2)}$)
		\item $invln2_h$ = \texttt{0x3FF7154760000000} (1.44269502162933349609 $\cdot 10^{-1}$)
		\item $invln2_l$ = \texttt{0x3E54AE0BF85DDF44} (1.92596299112661746887 $\cdot 10^{-8}$)
		\item $cp$       = \texttt{0x3FEEC709DC3A03FD} (9.61796693925975554329 $\cdot 10^{-1}$, equals $\frac{2}{3 \cdot ln(2)}$)
		\item $cp_h$     = \texttt{0x3FEEC709E0000000} (9.61796700954437255859 $\cdot 10^{-1}$)
		\item $cp_l$     = \texttt{0xBE3E2FE0145B01F5} (-7.02846165095275826516 $\cdot 10^{-9}$)
		\item $dp_h$     = \texttt{0x3FE2B80340000000} (5.84962487220764160156 $\cdot 10^{-1}$) %TODO what is this?
		\item $dp_l$     = \texttt{0x3E4CFDEB43CFD006} (1.35003920212974897128 $\cdot 10^{-8}$)
		\item $L1$       = \texttt{0x3FE3333333333303} (5.99999999999994648725 $\cdot 10^{-1}$)
		\item $L2$       = \texttt{0x3FDB6DB6DB6FABFF} (4.28571428578550184252 $\cdot 10^{-1}$)
		\item $L3$       = \texttt{0x3FD55555518F264D} (3.33333329818377432918 $\cdot 10^{-1}$)
		\item $L4$       = \texttt{0x3FD17460A91D4101} (2.72728123808534006489 $\cdot 10^{-1}$)
		\item $L5$       = \texttt{0x3FCD864A93C9DB65} (2.30660745775561754067 $\cdot 10^{-1}$)
		\item $L6$       = \texttt{0x3FCA7E284A454EEF} (2.06975017800338417784 $\cdot 10^{-1}$)
		\item $P1$       = \texttt{0x3FC555555555553E} (1.66666666666666019037 $\cdot 10^{-1}$)
		\item $P2$       = \texttt{0xBF66C16C16BEBD93} (-2.77777777770155933842 $\cdot 10^{-3}$)
		\item $P3$       = \texttt{0x3F11566AAF25DE2C} (6.61375632143793436117 $\cdot 10^{-5}$)
		\item $P4$       = \texttt{0xBEBBBD41C5D26BF1} (-1.65339022054652515390 $\cdot 10^{-6}$)
		\item $P5$       = \texttt{0x3E66376972BEA4D0} (4.13813679705723846039 $\cdot 10^{-8}$)
	\end{compactitem}
	\item If y is zero, return 1.
	\item If x is +1 and y is \texttt{NaN}, return 1.
	\item If either x or y is \texttt{NaN}, return the result of a call to \texttt{nan("")}.
	\item If x is < 0, determine if y is an odd integer as follows (the result shall be saved in the variable yisint, it shall be 0 if y is not an integer, 1 if it is odd, 2 if it is even):
	\begin{compactenum}
		\item If \texttt{highword} of y >= \texttt{0x43400000} \footnote{This means that y can only be even, as the exponent is so high that only integral values that are multiples of 2 are possible.}, set yisint to 2.
		\item If y >= 1:
		\begin{compactenum}
			\item If binary exponent k of y > 20:
			\begin{compactenum}
				\item Set j to the \texttt{lowword} of y shifted right by (52 - k).\footnote{In this case the lowest bit of j is the lowest bit that is in the integer part of y.}
				\item If (j shifted left by (52 - k)) equals the \texttt{lowword} of y \footnote{In this case the lowest (52 - k) bits of y are 0, therefore y has no fractional part and is integral.}, set yisint to (2 - last bit of j).
			\end{compactenum}
			\item If the \texttt{lowword} of y is 0:
			\begin{compactenum}
				\item Set j to the \texttt{highword} of y shifted right by (20 - k).
				\item If (j shifted left by (20 - k)) equals the \texttt{highword} of y, set yisint to (2 - last bit of j).
			\end{compactenum}
		\end{compactenum}
		\item If yisint has not yet been set, set it to 0.
	\end{compactenum}
	\item If the \texttt{lowword} of y is 0 \footnote{This is used to combine the other special cases for y, so that they can be skipped altogether instead of one after another which improves the performance of the 'normal' cases.}:
	\begin{compactenum}
		\item If y is infinite:
		\begin{compactenum}
			\item If x is 1, return 1.
			\item If |x| > 1:
			\begin{compactenum}
				\item If y is positive, return y.
				\item Return 0.
			\end{compactenum}
			\item Otherwise:
			\begin{compactenum}
				\item If y is positive, return 0.
				\item Return -y.
			\end{compactenum}
		\end{compactenum}
		\item If y is 1, return x.
		\item If y is -1, return $\frac{1}{x}$.
		\item If y is 2, return x $\cdot$ x.
		\item If y is 0.5 and x greater than or equal to positive zero, return $\sqrt{x}$, using \texttt{\_\_ieee754\_sqrt} to calculate the square root of x.
	\end{compactenum}
	\item Let $ax = |x|$, using \texttt{fabs} to calculate the absolute value of x.
	\item If x is infinite, a zero, -1 or 1:
	\begin{compactenum}
		\item If y < 0, let $z = \frac{1}{|x|} = \frac{1}{ax}$.
		\item If x < 0:
		\begin{compactenum}
			\item If yisint is 0 (y is not an integer) and x is -1, let $z =$ \texttt{NaN}.
			\item If yisint is 1 (y is an odd integer), let $z = -z$.
		\end{compactenum}
		\item Return z.
	\end{compactenum}
	\item If yisint is 0 (y is not an integer) and x < 0, return \texttt{NaN}.
	\item If yisint is 1 (y is an odd integer) and x < 0, set $sn = -1$, otherwise set $sn = +1$ (this contains the sign for the final result).
	\item The following implementation uses the method below to find x to the power of y:
	\begin{compactenum}
		\item Compute $log_2(x)$, with increased accuracy.
		\item Find an integral value n where $y \cdot log_2(x) = n + m$, and $|m| <= 0.5$.
		\item Then $x^y = 2^n \cdot e^{m \cdot log_2(x)}$.
	\end{compactenum}
	\item If |y| > $2^{31}$:
	\begin{compactenum}
		\item If |y| > $2^{64}$, as for such high y either an under- or overflow is guaranteed:
		\begin{compactenum}
			\item If |x| < 1:
			\begin{compactenum}
				\item If y < 0, return infinity with sign of $sn$, with overflow.
				\item Return 0 with sign of $sn$, with underflow.
			\end{compactenum}
			\item Otherwise:
			\begin{compactenum}
				\item If y > 0, return infinity with sign of $sn$, with overflow.
				\item Return 0 with sign of $sn$, with underflow.
			\end{compactenum}
		\end{compactenum}
		\item If \texttt{highword} of |x| < \texttt{0x3FEFFFFF} \footnote{This means that (1-x) >= $2^{-20}$.}:
		\begin{compactenum}
			\item If y < 0, return positive infinity, with overflow.
			\item Return 0, with underflow.
		\end{compactenum}
		\item If \texttt{highword} of |x| > \texttt{0x3FF00000} \footnote{This means that (1-x) <= $-2^{-20}$.}:
		\begin{compactenum}
			\item If y > 0, return positive infinity, with overflow.
			\item Return 0, with underflow.
		\end{compactenum}
		\item Set $t = |x| - 1 = ax - 1$.
		\item Set $w = t^2 \cdot (\frac{1}{2} - t \cdot (\frac{1}{3} - t \cdot \frac{1}{4}))$ which is an approximation for log(x) for x close to 1.
		\item Set $t1 = invln2_{h} \cdot t + (t \cdot invln2_{l} - w \cdot invln2)$, with \texttt{lowword} masked to 0.
		\item Set $t2 = (t \cdot invln2_{l} - w \cdot invln2) - (t1 - invln2_{h} \cdot t)$.
	\end{compactenum}
	\item Otherwise:
	\begin{compactenum}
		\item If x is subnormal, scale x and ax by multiplying them with $2^{53}$.
		\item Set n to the exponent of the original x \footnote{This shall be the real binary exponent: subnormals have an exponent < -1022.}.
		\item Normalize ix by setting the exponent to 0 \footnote{Set the three highest bytes of ix to \texttt{0x3FF0}.}.
		\item If |x| < $\sqrt{\frac{3}{2}}$ \footnote{This is when (ix with exponent masked) < \texttt{0x3988E}.}, set k to 0.
		\item If |x| < $\sqrt{3}$ \footnote{This is when (ix with exponent masked) < \texttt{0xBB67A}.}, set k to 1.
		\item If k has not been set in the two previous steps, set k to 0, increase n by 1, and decrease the exponent of ix by 1.
		\item Set the \texttt{highword} of ax to ix.
		\item Compute $s = \frac{ax-bp}{ax+bp}$, with $bp = 1+\frac{k}{2}$, with increased accuracy by splitting $s$ into $s_{h} + s_{l}$ by using the following formulae:
		\begin{align}
			s     &= \frac{ax-bp}{ax+bp} \\
			s_{h} &= highword\ of \bigg(\frac{ax-bp}{ax+bp}\bigg) \nonumber \\
			s_{l} &= \frac{1}{ax+bp} \cdot (((ax-bp) - s_{h} \cdot t_{h}) - s_{h} \cdot t_{l}) \nonumber
		\end{align}
		with
		\begin{compactitem}
			%\item $t_{h}$ has \texttt{highword} set to $((ix>>1)|0x20000000)+0x00080000+(k<<18)$ and \texttt{lowword} set to all zeroes.
			\item $t_{h} = ax + bp$ with \texttt{lowword} set to all zeroes.
			\item $t_{l} = ax - (t_{h}-bp)$.
		\end{compactitem}
		\item Compute the logarithm of ax with the following approximation (the theory behind the approximation is similar (smaller polynomial and in range $[\frac{\sqrt{3}}{2}, \sqrt{3}]$) to the one expressed for \_\_ieee754\_log and will not be presented here):
		\begin{align}
			R(s)   &= s^2 \cdot (L1 + s^2 \cdot (L2 + s^2 \cdot (L3 + s^2 \cdot (L4 + s^2 \cdot (L5 + s^2 \cdot L6))))) \nonumber \\
			r      &= s^2 \cdot R(s) + s_{l} \cdot (s_{h} + s) \nonumber \\
			t_{h}  &= 3 + s_{h}^2 + r \quad \wedge \quad lowword\ of\ t_{h}\ set\ to\ all\ zeroes \nonumber \\
			t_{l}  &= r - ((t_{h} - 3) - s_{h}^2) \nonumber \\
			p_{h}  &= s_{h} \cdot t_{h} + (s_{l} \cdot t_{h} + t_{l} \cdot s) \quad \wedge \quad lowword\ of\ p_{h}\ set\ to\ all\ zeroes \nonumber \\
			p_{l}  &= (s_{l} \cdot t_{h} + t_{l} \cdot s) - (p_{h} - (s_{h} \cdot t_{h})) \nonumber \\
			z_{h}  &= cp_h \cdot p_h \nonumber \\
			z_{l}  &= cp_l \cdot p_h + p_l \cdot cp + dp_l \nonumber \\
			t1     &= z_h+z_l+dp_h+n \\
			t2     &= z_l-(((t1-n)-dp_h)-z_h)
		\end{align}
		with
		\begin{compactitem}
			\item $dp_h$ and $dp_l$ are zero if k is zero, otherwise they have the values described in step 1.
		\end{compactitem}
	\end{compactenum}
	\item Split y into $y1+y2$:
	\begin{compactitem}
		\item $y1 = y$ with \texttt{lowword} set to all zeroes.
		\item $y2 = y - y1$.
	\end{compactitem}
	\item Calculate $y \cdot log_2(x)$ as follows:
	\begin{align}
		p_{l}            &= y2 \cdot t1 + y \cdot t2 \nonumber \\
		p_{h}            &= y1 \cdot t1 \nonumber \\
		y \cdot log_2(x) &= p_l + p_h
	\end{align}
	\item If $y \cdot log_2(x) >= 1024$:
	\begin{compactenum}
		\item If $y \cdot log_2(x) > 1024$ return infinity with the sign of $sn$, with overflow.
		\item If $p_l + ovt > y \cdot log_2(x) - p_h$, with $ovt$ = 8.0085662595372944372 $\cdot 10^{-17}$ \footnote{Which equals $-(1024-log_2(overflow+0.5\ ULP))$.}, return infinity with the sign of $sn$, with overflow.
	\end{compactenum}
	\item If $y \cdot log_2(x) <= -1075$:
	\begin{compactenum}
		\item If $y \cdot log_2(x) < -1075$ return zero with the sign of $sn$, with underflow.
		\item If $p_l <= y \cdot log_2(x) - p_h$ return zero with the sign of $sn$, with underflow.
	\end{compactenum}
	\item Calculate $e^{m \cdot log_2(x)}$:
	\begin{compactenum}
		\item Set $k =$ exponent of $y \cdot log_2(x)$, and $n = 0$.
		\item If $|y \cdot log_2(x)| > 0.5$:
		\begin{compactenum}
			\item Set $n = $ \texttt{highword} of $(y \cdot log_2(x) + 0.5)$.
			\item Set $k =$ exponent of n.
			\item Set $t$ to a new double with (exponent of n including sign) right shifted by k as \texttt{highword}, and all zeros as \texttt{lowword}.
			\item Replace the exponent of n with 1, then right shift n by (20-k).
			\item If $y \cdot log_2(x) < 0$ set the sign of n.
			\item Set $p_h = p_h - t$.
		\end{compactenum}
		\item Calculate $e^{m \cdot log_2(x)}$ with the following approximation (the theory behind the approximation is the one expressed for \_\_ieee754\_exp and will not be presented here):
		\begin{align}
			t                     &= p_l + p_h \quad \wedge \quad lowword\ of\ t\ set\ to\ all\ zeroes \nonumber \\
			z                     &= (t \cdot lg2_h) + ((p_l-(t-p_h)) \cdot lg2 + t \cdot lg2_l) \nonumber \\
			w                     &= ((p_l-(t-p_h)) \cdot lg2 + t \cdot lg2_l) - (z - (t \cdot lg2_h)) \nonumber \\
			t1                    &= z - z^2 \cdot (P1 + z^2 \cdot (P2 + z^2 \cdot (P3 + z^2 \cdot (P4 + z^2 \cdot P5)))) \nonumber \\
			r                     &= \frac{z \cdot t1}{t1-2}-(w+z \cdot w) \nonumber \\
			e^{m \cdot log_2(x)}  &= 1 - (r-z)
		\end{align}
	\end{compactenum}
	\item If (exponent of $e^{m \cdot log_2(x)}$ + n) <= 0:
	\begin{compactenum}
		\item  Set $z = e^{m \cdot log_2(x)} \cdot 2^n$, using the \texttt{scalbn} function.
		\item Return z with sign of s.
	\end{compactenum}
	\item Set $z = e^{m \cdot log_2(x)}$ with exponent set to n.
	\item Return z with sign of $sn$.
\end{compactenum}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./figure/Ieee_Pow_Flowchart.pdf}
	\caption{Flowchart \_\_ieee754\_pow, part 1/3}
	\label{fig:flowchart-ieee_pow}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./figure/Ieee_Pow_flowchart_2.pdf}
	\caption{Flowchart \_\_ieee754\_pow, part 2/3}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./figure/Ieee_Pow_flowchart_3.pdf}
	\caption{Flowchart \_\_ieee754\_pow, part 3/3}
\end{figure}